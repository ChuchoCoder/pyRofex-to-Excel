name: Package Release
run-name: >-
  Publish to ${{ github.event_name == 'release' && 'pypi' || (github.event_name == 'workflow_dispatch' && inputs.repository || 'testpypi') }} -
  ${{ github.event_name == 'release' && github.event.release.tag_name || (github.event_name == 'pull_request' && format('pr-{0}-{1}', github.event.pull_request.number, github.head_ref) || github.ref_name) }}

on:
  workflow_dispatch:
    inputs:
      repository:
        description: "Destino de publicación"
        required: true
        default: testpypi
        type: choice
        options:
          - testpypi
          - pypi
  release:
    types:
      - published
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

permissions:
  contents: read

concurrency:
  group: package-release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PR_NUMBER: ${{ github.event_name == 'pull_request' && github.event.pull_request.number || 0 }}
      BRANCH_NAME: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install packaging tools
        run: |
          python -m pip install --upgrade pip
          python -m pip install build twine

      - name: Generate TestPyPI dev version
        if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && inputs.repository == 'testpypi')
        shell: bash
        run: |
          python - <<'PY'
          import hashlib
          import os
          import pathlib
          import re

          pyproject = pathlib.Path("pyproject.toml")
          content = pyproject.read_text(encoding="utf-8")
          match = re.search(r'^version\s*=\s*"([^"]+)"', content, flags=re.MULTILINE)
          if not match:
              raise RuntimeError("No se encontró la versión en pyproject.toml")

          base_version = match.group(1)
          base_version = re.sub(r'(?i)(\.dev\d+|a\d+|b\d+|rc\d+|post\d+)$', '', base_version)

          branch_name = os.environ.get("BRANCH_NAME", "unknown")
          branch_slug = re.sub(r'[^a-z0-9]+', '-', branch_name.lower()).strip('-') or 'branch'
          branch_hash = int(hashlib.sha256(branch_slug.encode("utf-8")).hexdigest()[:8], 16)

          pr_number = int(os.environ.get("PR_NUMBER", "0"))
          run_number = int(os.environ.get("GITHUB_RUN_NUMBER", "0"))

          dev_number = f"{pr_number:04d}{run_number:06d}{branch_hash % 10000:04d}"
          test_version = f"{base_version}.dev{dev_number}"

          updated = re.sub(
              r'^version\s*=\s*"[^"]+"',
              f'version = "{test_version}"',
              content,
              count=1,
              flags=re.MULTILINE,
          )
          pyproject.write_text(updated, encoding="utf-8")

          with open(os.environ["GITHUB_ENV"], "a", encoding="utf-8") as env_file:
              env_file.write(f"TESTPYPI_VERSION={test_version}\n")

          print(f"Generated TestPyPI version: {test_version}")
          PY

      - name: Build package
        run: python -m build

      - name: Check distribution metadata
        run: python -m twine check dist/*

      - name: Upload dist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/*

  publish-testpypi:
    runs-on: ubuntu-latest
    needs: build
    if: (github.event_name == 'workflow_dispatch' && inputs.repository == 'testpypi') || github.event_name == 'pull_request'
    environment: testpypi
    permissions:
      id-token: write
      pull-requests: write
      issues: write
    steps:
      - name: Download dist artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist

      - name: Build TestPyPI install command summary
        shell: bash
        run: |
          python - <<'PY'
          import glob
          import os
          import pathlib
          import re

          wheels = sorted(glob.glob("dist/*.whl"))
          if not wheels:
              print("No wheel found in dist/; skipping summary generation")
              raise SystemExit(0)

          wheel = pathlib.Path(wheels[0]).name
          match = re.match(r"(?P<name>.+)-(?P<version>[^-]+)-", wheel)
          if not match:
              print(f"Could not parse wheel filename: {wheel}")
              raise SystemExit(0)

          package_name = match.group("name").replace("_", "-")
          version = match.group("version")

          summary = os.environ.get("GITHUB_STEP_SUMMARY")
          if not summary:
              raise SystemExit(0)

          install_cmd = f"pip install -i https://test.pypi.org/simple/ {package_name}=={version}"
          with open(os.environ["GITHUB_ENV"], "a", encoding="utf-8") as env_file:
              env_file.write(f"TESTPYPI_PACKAGE={package_name}\n")
              env_file.write(f"TESTPYPI_VERSION={version}\n")
              env_file.write(f"TESTPYPI_INSTALL_CMD={install_cmd}\n")

          with open(summary, "a", encoding="utf-8") as f:
              f.write("## TestPyPI package\\n")
              f.write(f"- Package: `{package_name}`\\n")
              f.write(f"- Version: `{version}`\\n")
              f.write(f"- Install: `{install_cmd}`\\n")

          print(f"Generated TestPyPI install command: {install_cmd}")
          PY

      - name: Publish to TestPyPI
        if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          packages-dir: dist
          skip-existing: true

      - name: Comment PR with TestPyPI install command
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        uses: actions/github-script@v7
        env:
          TESTPYPI_PACKAGE: ${{ env.TESTPYPI_PACKAGE }}
          TESTPYPI_VERSION: ${{ env.TESTPYPI_VERSION }}
          TESTPYPI_INSTALL_CMD: ${{ env.TESTPYPI_INSTALL_CMD }}
        with:
          script: |
            const marker = '<!-- testpypi-install-command -->';
            const body = [
              marker,
              '### TestPyPI package listo para probar',
              `- Package: \`${process.env.TESTPYPI_PACKAGE}\``,
              `- Version: \`${process.env.TESTPYPI_VERSION}\``,
              `- Install: \`${process.env.TESTPYPI_INSTALL_CMD}\``,
            ].join('\n');

            const issue_number = context.payload.pull_request.number;
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              per_page: 100,
            });

            const existing = comments.find(
              (comment) =>
                comment.user?.type === 'Bot' &&
                comment.body &&
                comment.body.includes(marker)
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number,
                body,
              });
            }

  publish-pypi:
    runs-on: ubuntu-latest
    needs: build
    if: (github.event_name == 'workflow_dispatch' && inputs.repository == 'pypi') || github.event_name == 'release'
    environment: pypi
    permissions:
      id-token: write
    steps:
      - name: Download dist artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist
